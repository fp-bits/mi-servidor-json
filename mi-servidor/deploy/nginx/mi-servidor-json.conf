# ========================================
# Configuración Nginx - Reverse Proxy
# ========================================
# Ubicación en VPS: /etc/nginx/sites-available/mi-servidor-json
#
# Instalación:
#   sudo cp mi-servidor-json.conf /etc/nginx/sites-available/mi-servidor-json
#   sudo ln -s /etc/nginx/sites-available/mi-servidor-json /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx
#
# Este archivo configura Nginx como reverse proxy que:
# - Escucha en puerto 80 (HTTP)
# - Reenvía peticiones a Node.js en localhost:3000
# - Añade headers necesarios para proxying
# - Gestiona logs

server {
    # Puerto y nombre del servidor
    listen 80;
    listen [::]:80;

    # Subdominio configurado
    server_name api.qu3v3d0.tech;

    # Logs específicos para este virtual host
    access_log /var/log/nginx/mi-servidor-json.access.log;
    error_log /var/log/nginx/mi-servidor-json.error.log warn;

    # ========================================
    # PROXY A NODE.JS
    # ========================================
    # Todo el tráfico se envía al servidor Node.js
    location / {
        # URL del servidor Node.js (localhost:3000)
        proxy_pass http://localhost:3000;

        # Protocolo HTTP/1.1 necesario para conexiones persistentes
        proxy_http_version 1.1;

        # Headers necesarios para WebSockets (si los usas en el futuro)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Header Host: el dominio original solicitado
        proxy_set_header Host $host;

        # IP real del cliente (importante para logs)
        proxy_set_header X-Real-IP $remote_addr;

        # Cadena de IPs si hay múltiples proxies
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Protocolo original (http o https)
        proxy_set_header X-Forwarded-Proto $scheme;

        # No cachear respuestas en caso de upgrade
        proxy_cache_bypass $http_upgrade;

        # Timeouts (ajustar según necesidades)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================
    # ENDPOINT DE SALUD (healthcheck)
    # ========================================
    # Nginx responde directamente sin pasar por Node.js
    # Útil para monitorización (Nagios, Zabbix, etc.)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ========================================
    # NGINX STATUS (opcional, solo para admin)
    # ========================================
    # Descomenta para ver estadísticas de Nginx
    # location /nginx_status {
    #     stub_status on;
    #     access_log off;
    #     # Restringir por IP (cambiar 192.168.1.0/24 por tu red)
    #     allow 192.168.1.0/24;
    #     deny all;
    # }

    # ========================================
    # SEGURIDAD BÁSICA
    # ========================================

    # Ocultar versión de Nginx en headers
    server_tokens off;

    # Denegar acceso a archivos ocultos (.git, .env, etc.)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ========================================
    # ARCHIVOS ESTÁTICOS (si los tienes)
    # ========================================
    # Si tienes carpeta /public con CSS, JS, imágenes:
    # location /static/ {
    #     alias /opt/mi-servidor-json/mi-servidor/public/;
    #     expires 7d;
    #     add_header Cache-Control "public, immutable";
    # }
}

# ========================================
# CONFIGURACIÓN HTTPS (SSL/TLS)
# ========================================
# Descomenta y configura después de obtener certificado SSL
# (usar Let's Encrypt con certbot)

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#
#     server_name api.qu3v3d0.tech;
#
#     # Certificados SSL (generados con certbot)
#     ssl_certificate /etc/letsencrypt/live/api.qu3v3d0.tech/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.qu3v3d0.tech/privkey.pem;
#
#     # Configuración SSL moderna (Mozilla SSL Configuration Generator)
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
#     ssl_prefer_server_ciphers off;
#
#     # HSTS (15768000 segundos = 6 meses)
#     add_header Strict-Transport-Security "max-age=15768000" always;
#
#     # ... resto de configuración igual que HTTP ...
#
#     location / {
#         proxy_pass http://localhost:3000;
#         # ... mismo proxy config ...
#     }
# }

# # Redirigir HTTP a HTTPS
# server {
#     listen 80;
#     listen [::]:80;
#     server_name api.qu3v3d0.tech;
#     return 301 https://$server_name$request_uri;
# }
